<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>UPCHAIN - 모의투자</title>
    <link rel="stylesheet" href="css/style.css" />

    <!-- 아이콘 -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/remixicon@3.6.0/fonts/remixicon.css"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <!-- 상단 네비게이션 -->
    <header class="navbar">
      <div class="nav-inner">
        <div class="nav-logo">UPCHAIN</div>
        <nav class="nav-links">
          <a href="index.html">ABOUT</a>
          <a href="project.html">PROJECT</a>
          <a href="games.html">GAMES</a>
          <a class="active" href="Mock-Trading.html">MOCK TRADING</a>
          <a href="news.html">NEWS</a>
          <a href="contact.html">CONTACT</a>
        </nav>
      </div>
    </header>

    <!-- 메인 레이아웃 -->
    <main class="mock-layout">
      <!-- 왼쪽: 설명 영역 (슬라이드 느낌) -->
      <section class="mock-left card">
        <div class="info-title-box">
          <span class="info-title-text">모의투자</span>
        </div>

        <h2 class="info-section-title">게임 목적</h2>
        <p class="info-section-body">
          업비트와 유사한 UI에서 실제 거래 흐름(매수·매도·차트)을 직접 조작해보는
          체험형 기능
        </p>

        <h2 class="info-section-title">게임 규칙</h2>
        <ul class="info-rule-list">
          <li>① 코인 선택</li>
          <li>② 지정된 금액(1회 100,000원)으로 가상 매수</li>
          <li>③ 실제 업비트 시세를 불러와 평가수익을 계산</li>
          <li>④ 수익률을 확인하고 투자 흐름을 체험</li>
        </ul>

        <h2 class="info-section-title">체험 효과</h2>
        <ul class="info-effect-list">
          <li>· 실전과 거의 비슷한 화면에서 매수 버튼·차트 흐름을 조작</li>
          <li>· 처음 보는 사람도 업비트 UI를 사전에 익숙하게 만드는 목적</li>
          <li>· “투자는 이렇게 진행되는구나”라는 실제 서비스 흐름 이해 제공</li>
        </ul>
      </section>

      <!-- 오른쪽: 실제 모의투자 보드 -->
      <section class="mock-board card">
        <!-- 상단: 코인선택 + 현재가 -->
        <div class="board-top">
          <div class="board-market">
            <label for="mt-market" class="label-small">코인 선택</label>
            <select id="mt-market" class="market-select"></select>
          </div>

          <div class="board-current">
            <div class="label-small">현재가</div>
            <div id="mt-current" class="current-price">- 원</div>
          </div>
        </div>

        <!-- 두 번째 줄: 잔액 / 보유 / 평단 -->
        <div class="board-summary">
          <div class="summary-item">
            <div class="label-small">가상 잔액</div>
            <div id="mt-cash" class="summary-value">-</div>
          </div>
          <div class="summary-item">
            <div class="label-small">보유 수량</div>
            <div id="mt-volume" class="summary-value">-</div>
          </div>
          <div class="summary-item">
            <div class="label-small">평균 매수가</div>
            <div id="mt-avg" class="summary-value">-</div>
          </div>
        </div>

        <!-- 평가손익 / 수익률 박스 -->
        <div class="board-pnl">
          <div>
            <div class="pnl-title">평가손익</div>
            <div id="mt-pnl" class="pnl-value">-</div>
          </div>
          <div class="pnl-divider"></div>
          <div class="pnl-right">
            <div class="pnl-title">수익률</div>
            <div id="mt-pnl-rate" class="pnl-rate">-</div>
          </div>
        </div>

        <!-- 1분봉 차트 -->
        <div class="board-chart">
          <div class="label-small">1분봉 가격 차트 (최근 50개)</div>
          <div class="chart-container">
            <canvas id="mt-chart"></canvas>
          </div>
        </div>

        <!-- 버튼 -->
        <div class="board-buttons">
          <button id="mt-buy" class="btn primary large">
            <i class="ri-arrow-up-circle-line"></i>
            100,000원 가상 매수
          </button>
          <button id="mt-reset" class="btn outline large">초기화</button>
        </div>

        <!-- 안내문 -->
        <p class="board-notice">
          * 실제 주문/자산과 완전히 분리된 체험용 화면입니다. 업비트 Open API는
          <strong>공개 시세</strong>만 사용합니다.
        </p>
      </section>
    </main>

    <!-- 모의투자 JS -->
    <script>
      // ===== 기본 상수 =====
      const ORDER_AMOUNT = 100_000; // 1회 가상 매수 금액
      const INITIAL_CASH = 1_000_000; // 시작 가상 잔액

      // 사용 코인 목록
      const COINS = [
        { market: "KRW-BTC", name: "비트코인" },
        { market: "KRW-ETH", name: "이더리움" },
        { market: "KRW-XRP", name: "리플" },
        { market: "KRW-SOL", name: "솔라나" },
      ];

      // 상태
      const state = {
        market: "KRW-BTC",
        cash: INITIAL_CASH,
        volume: 0,
        avgPrice: 0,
        lastPrice: 0,
      };

      // 차트 인스턴스
      let mtChart = null;

      const $ = (id) => document.getElementById(id);

      // ===== 코인 셀렉트 초기화 =====
      function initMarketSelect() {
        const select = $("mt-market");
        COINS.forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c.market;
          opt.textContent = `${c.name} (${c.market})`;
          select.appendChild(opt);
        });
        select.value = state.market;

        select.addEventListener("change", () => {
          state.market = select.value;
          fetchTicker();
          fetchCandles();
        });
      }

      // ===== 현재가 가져오기 =====
      async function fetchTicker() {
        try {
          const res = await fetch(`/api/ticker?markets=${state.market}`);
          const data = await res.json();
          const item = data[0];

          state.lastPrice = item.trade_price;

          updatePriceUI(item);
          updatePnlUI();
        } catch (e) {
          console.error("ticker error", e);
        }
      }

      function updatePriceUI(item) {
        const el = $("mt-current");
        const price = Number(item.trade_price).toLocaleString();
        const rate = item.signed_change_rate * 100;

        el.textContent = `${price} 원`;

        el.className = "current-price";
        if (rate > 0) el.classList.add("rise");
        else if (rate < 0) el.classList.add("fall");
      }

      // ===== 캔들 가져오기 =====
      async function fetchCandles() {
        try {
          const res = await fetch(`/api/candles?market=${state.market}&count=50`);
          const data = await res.json();

          const candles = data.slice().reverse(); // 시간순 정렬
          const labels = candles.map((c) =>
            new Date(c.timestamp).toLocaleTimeString("ko-KR", {
              hour: "2-digit",
              minute: "2-digit",
            })
          );
          const prices = candles.map((c) => c.trade_price);

          drawChart(labels, prices);
        } catch (e) {
          console.error("candles error", e);
        }
      }

      // ===== 차트 그리기 =====
      function drawChart(labels, prices) {
        const ctx = $("mt-chart").getContext("2d");

        if (mtChart) {
          mtChart.data.labels = labels;
          mtChart.data.datasets[0].data = prices;
          mtChart.update();
          return;
        }

        mtChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "가격",
                data: prices,
                borderWidth: 2,
                tension: 0.25,
                pointRadius: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: { maxTicksLimit: 6 },
                grid: { display: false },
              },
              y: {
                ticks: {
                  callback: (v) => v.toLocaleString(),
                },
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) =>
                    `${ctx.parsed.y.toLocaleString()} 원`,
                },
              },
            },
          },
        });
      }

      // ===== 잔액/보유/평단 UI =====
      function updateBalanceUI() {
        $("mt-cash").textContent = state.cash.toLocaleString() + " 원";
        $("mt-volume").textContent = state.volume.toFixed(6) + " 개";
        $("mt-avg").textContent = state.avgPrice
          ? state.avgPrice.toLocaleString() + " 원"
          : "-";
      }

      // ===== 평가손익/수익률 UI =====
      function updatePnlUI() {
        if (!state.lastPrice || state.volume === 0) {
          $("mt-pnl").textContent = "-";
          $("mt-pnl-rate").textContent = "-";
          $("mt-pnl").className = "pnl-value";
          $("mt-pnl-rate").className = "pnl-rate";
          return;
        }

        const buyAmount = INITIAL_CASH - state.cash;
        const evalAmount = state.lastPrice * state.volume;
        const pnl = evalAmount - buyAmount;
        const rate = (pnl / buyAmount) * 100;

        let cls = "";
        if (pnl > 0) cls = "plus";
        else if (pnl < 0) cls = "minus";

        $("mt-pnl").textContent = pnl.toLocaleString() + " 원";
        $("mt-pnl-rate").textContent = rate.toFixed(2) + " %";

        $("mt-pnl").className = "pnl-value " + cls;
        $("mt-pnl-rate").className = "pnl-rate " + cls;
      }

      // ===== 10만원 가상 매수 =====
      function handleBuy() {
        if (!state.lastPrice) return;

        if (state.cash < ORDER_AMOUNT) {
          alert("가상 잔액이 부족합니다. 초기화 후 다시 시도해주세요.");
          return;
        }

        const qty = ORDER_AMOUNT / state.lastPrice;
        const totalCost = state.avgPrice * state.volume + ORDER_AMOUNT;
        const newVolume = state.volume + qty;
        const newAvgPrice = totalCost / newVolume;

        state.cash -= ORDER_AMOUNT;
        state.volume = newVolume;
        state.avgPrice = newAvgPrice;

        updateBalanceUI();
        updatePnlUI();
      }

      // ===== 초기화 =====
      function handleReset() {
        state.cash = INITIAL_CASH;
        state.volume = 0;
        state.avgPrice = 0;
        updateBalanceUI();
        updatePnlUI();
      }

      // ===== 초기 실행 =====
      function initMockTrading() {
        initMarketSelect();
        updateBalanceUI();

        fetchTicker();
        fetchCandles();

        $("mt-buy").addEventListener("click", handleBuy);
        $("mt-reset").addEventListener("click", handleReset);

        // 5초마다 갱신
        setInterval(() => {
          fetchTicker();
          fetchCandles();
        }, 5000);
      }

      document.addEventListener("DOMContentLoaded", initMockTrading);
    </script>
  </body>
</html>
